---
phase: 02-storage-enhancements
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/duckdb_buffer.rs, src/app_controller.rs]
autonomous: true
must_haves:
  truths:
    - "Old logs are deleted automatically based on time"
    - "Old processes are deleted automatically based on time"
    - "Database size is kept within limits by deleting oldest data"
    - "Database is backed up before migrations"
  artifacts:
    - path: "src/app_controller.rs"
      provides: "Background cleanup loop"
---

<objective>
Implement the automated cleanup logic based on configured retention policies and ensure database safety during migrations.
</objective>

<execution_context>
@/home/agentsmith/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-storage-enhancements/02-01-SUMMARY.md
@src/duckdb_buffer.rs
@src/app_controller.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Retention Cleanup Logic</name>
  <files>src/duckdb_buffer.rs</files>
  <action>
    - Add `enforce_retention` method to `DuckDBBuffer` that:
        - Deletes records from `journal_logs` older than `log_retention_days`.
        - Deletes records from `process_metrics` older than `process_retention_days`.
        - Checks database file size. If > `log_max_size_gb`, delete oldest blocks of logs until under limit.
        - Checks database file size. If > `process_max_size_gb`, delete oldest blocks of processes until under limit.
        - Runs `VACUUM` after deletions.
    - The method must run to completion once invoked -- do NOT check cancellation tokens or yield points mid-cleanup. This satisfies the "Uninterruptible" user decision: once a cleanup cycle starts, it completes the full cycle.
  </action>
  <verify>
    - Insert old records manually and verify they are removed after calling cleanup.
    - Mock file size or use small limits to verify size-based cleanup.
  </verify>
  <done>
    - Retention logic correctly handles both Time and Size limits.
    - Cleanup runs atomically to completion once started (uninterruptible).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Background Cleanup and Auto-Backup</name>
  <files>src/app_controller.rs, src/config.rs</files>
  <action>
    - Add `cleanup_interval_minutes` to Settings in `src/config.rs` with default 10, validated to the range 5-15 (per user decision: "every 5-15 minutes"). Clamp out-of-range values to nearest bound. Add corresponding CLI flag `--cleanup-interval` and env var `LIVEDATA_RETENTION_CLEANUP_INTERVAL`.
    - Implement a background cleanup task in `ApplicationController` using `tokio::spawn` (not `spawn_blocking`) so it runs as a high-priority async task. Use `tokio::time::interval(Duration::from_secs(cleanup_interval_minutes * 60))` for the periodic loop.
    - The spawned task must NOT use `tokio::select!` with a cancellation token around the `enforce_retention()` call. Instead, check shutdown signal only BETWEEN cleanup cycles (after each cycle completes), never during. This ensures cleanup is uninterruptible per user decision.
    - Run cleanup once immediately at startup (first tick), then periodically.
    - Implement `backup_database` method that copies the DuckDB file to a `.bak` before starting migrations in `new()`.
    - Log "Starting periodic storage cleanup (interval: {N}m, priority: high)" at startup.
  </action>
  <verify>
    - Check log output for "Starting periodic storage cleanup (interval: 10m, priority: high)".
    - Verify `.bak` file exists after a migration is triggered.
    - Confirm `cargo run -- --help` shows `--cleanup-interval` flag.
    - Verify setting `--cleanup-interval 3` clamps to 5 (minimum) and `--cleanup-interval 20` clamps to 15 (maximum).
  </verify>
  <done>
    - Cleanup is automated with configurable interval (5-15 min range per user decision).
    - Cleanup tasks run at high priority and complete uninterrupted once started.
    - Database is backed up before schema migrations.
  </done>
</task>

</tasks>

<verification>
- `cargo test` passes.
- Database size is maintained under configured limits.
- Retention policies are enforced automatically.
</verification>

<success_criteria>
- Automated storage management is functional.
- Zero-manual-intervention cleanup is active.
- Cleanup interval is configurable within 5-15 minute range.
- Cleanup cycles are uninterruptible and run at high priority.
</success_criteria>

<output>
After completion, create `.planning/phases/02-storage-enhancements/02-02-SUMMARY.md`
</output>
