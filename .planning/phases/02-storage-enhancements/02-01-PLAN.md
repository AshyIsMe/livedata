---
phase: 02-storage-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/config.rs, src/lib.rs, src/main.rs, src/duckdb_buffer.rs, Cargo.toml]
autonomous: true
must_haves:
  truths:
    - "User can see retention flags in --help"
    - "Application automatically upgrades database schema without manual migration"
    - "Database contains process_metrics table on startup"
  artifacts:
    - path: "src/config.rs"
      provides: "Consolidated configuration management"
    - path: "src/duckdb_buffer.rs"
      provides: "Schema migration and process table"
---

<objective>
Establish the configuration system and upgrade the database to support versioning and new data types.
</objective>

<execution_context>
@/home/agentsmith/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/main.rs
@src/duckdb_buffer.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Configuration System</name>
  <files>src/config.rs, src/lib.rs, src/main.rs, Cargo.toml</files>
  <action>
    - Add `config` and `serde` features to Cargo.toml.
    - Create `src/config.rs` defining `Settings` struct with:
        - `log_retention_days` (default 30)
        - `log_max_size_gb` (default 1)
        - `process_retention_days` (default 7)
        - `process_max_size_gb` (default 0.5)
        - `config_file` path (default ~/.livedata/config.toml)
    - Implement logic to merge CLI flags (via `Args`), Env vars (`LIVEDATA_RETENTION_*`), and TOML config file.
    - Export `mod config` in `src/lib.rs`.
    - Update `main.rs` to use consolidated settings.
  </action>
  <verify>
    - `cargo run -- --help` shows new retention-related flags.
    - Config file is created at default location if missing.
  </verify>
  <done>
    - Configuration merges CLI, Env, and File correctly with CLI taking precedence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Schema Evolution and Process Metrics Table</name>
  <files>src/duckdb_buffer.rs</files>
  <action>
    - Add `_schema_version` table to track migration state.
    - Implement migration runner in `DuckDBBuffer::new` that applies missing migrations.
    - Migration 1: Create `process_metrics` table with columns:
        - `timestamp` (TIMESTAMP)
        - `pid` (INTEGER)
        - `name` (TEXT)
        - `cpu_usage` (DOUBLE)
        - `mem_usage` (DOUBLE)
        - `user` (TEXT)
        - `runtime` (BIGINT)
    - Migration 1: Ensure `journal_logs` and indexes are up to date.
  </action>
  <verify>
    - Run the application.
    - Check DuckDB schema using `duckdb data/livedata.duckdb "DESCRIBE process_metrics;"`
    - Verify migration tracking: `duckdb data/livedata.duckdb "SELECT * FROM _schema_version;"` confirms migration table exists and records applied migrations.
  </verify>
  <done>
    - Database schema is versioned.
    - `process_metrics` table exists.
    - `_schema_version` table tracks which migrations have been applied.
  </done>
</task>

</tasks>

<verification>
- `cargo check` passes.
- `cargo test` passes.
- Application starts and creates the expected database tables.
</verification>

<success_criteria>
- Retention settings are configurable via multiple sources.
- Database schema supports versioning and process data.
</success_criteria>

<output>
After completion, create `.planning/phases/02-storage-enhancements/02-01-SUMMARY.md`
</output>
