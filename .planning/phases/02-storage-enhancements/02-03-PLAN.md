---
phase: 02-storage-enhancements
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/process_monitor.rs, src/app_controller.rs, src/web_server.rs, src/duckdb_buffer.rs]
autonomous: true
must_haves:
  truths:
    - "Process metrics are persisted to DuckDB"
    - "/api/storage/health returns database statistics"
    - "Process monitor UI can display historical process data"
  artifacts:
    - path: "src/web_server.rs"
      provides: "/api/storage/health and /api/processes historical query"
  key_links:
    - from: "src/process_monitor.rs"
      to: "src/app_controller.rs"
      via: "tokio::sync::mpsc channel sending ProcessMetricsBatch messages"
      pattern: "mpsc::Sender<ProcessMetricsBatch>"
    - from: "src/app_controller.rs"
      to: "src/duckdb_buffer.rs"
      via: "receiver task calling buffer.add_process_metrics()"
      pattern: "add_process_metrics"
---

<objective>
Persist process monitoring data to the database and provide a health API for storage monitoring.
</objective>

<execution_context>
@/home/agentsmith/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-storage-enhancements/02-01-SUMMARY.md
@src/process_monitor.rs
@src/web_server.rs
@src/duckdb_buffer.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Persist Process Metrics</name>
  <files>src/duckdb_buffer.rs, src/process_monitor.rs, src/app_controller.rs</files>
  <action>
    - Add `add_process_metrics` method to `DuckDBBuffer` that accepts a `Vec<ProcessInfo>` and batch-inserts them into the `process_metrics` table.
    - Define a `ProcessMetricsBatch` struct (in `src/process_monitor.rs` or a shared types module) containing `Vec<ProcessInfo>` and a `timestamp: chrono::DateTime<Utc>`.
    - Create an `mpsc` channel in `ApplicationController::new()`:
        ```rust
        let (metrics_tx, mut metrics_rx) = tokio::sync::mpsc::channel::<ProcessMetricsBatch>(32);
        ```
    - Pass the `metrics_tx: Sender<ProcessMetricsBatch>` to `ProcessMonitor` (add it as a field). In `ProcessMonitor`'s collection loop, after gathering process snapshots, send the batch via `metrics_tx.send(batch).await`. Log a warning if the channel is full (try_send returning Full) but do not block collection.
    - Spawn a dedicated receiver task in `ApplicationController` that loops on `metrics_rx.recv().await` and calls `buffer.add_process_metrics(batch.processes)` for each received message. Handle errors by logging them (do not panic).
    - Error handling: If `add_process_metrics` fails (e.g., DuckDB write error), log the error and continue receiving. Do not drop the channel.
  </action>
  <verify>
    - Run the application for 30 seconds.
    - Check `process_metrics` table has rows: `duckdb data/livedata.duckdb "SELECT COUNT(*) FROM process_metrics;"`
  </verify>
  <done>
    - Every collection interval, process data is sent via mpsc channel and written to the database.
    - Channel-based architecture cleanly separates collection from persistence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Storage Health API</name>
  <files>src/web_server.rs</files>
  <action>
    - Add `/api/storage/health` endpoint returning:
        - `database_size_bytes`
        - `journal_log_count`
        - `process_metric_count`
        - `oldest_log_timestamp`
        - `newest_log_timestamp`
        - `retention_policy` (from config)
    - Update `api_processes` to support optional time range queries (defaults to latest snapshot if no range).
  </action>
  <verify>
    - `curl http://localhost:3000/api/storage/health` returns valid JSON.
  </verify>
  <done>
    - System health and historical process data are accessible via API.
  </done>
</task>

</tasks>

<verification>
- `cargo run` and verify both logs and processes are being stored.
- API returns accurate storage statistics.
</verification>

<success_criteria>
- Process data persists across restarts.
- Storage stats are programmatically accessible.
</success_criteria>

<output>
After completion, create `.planning/phases/02-storage-enhancements/02-03-SUMMARY.md`
</output>
